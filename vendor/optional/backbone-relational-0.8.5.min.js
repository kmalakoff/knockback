/**
 * Backbone-relational.js 0.8.5
 * (c) 2011-2013 Paul Uithol and contributors (https://github.com/PaulUithol/Backbone-relational/graphs/contributors)
 *
 * Backbone-relational may be freely distributed under the MIT license; see the accompanying LICENSE.txt.
 * For details and documentation: https://github.com/PaulUithol/Backbone-relational.
 * Depends on Backbone (and thus on Underscore as well): https://github.com/documentcloud/backbone.
 */
(function(e){"use strict";var t,n,r;if(typeof window==="undefined"){t=require("underscore");n=require("backbone");r=module.exports=n}else{t=window._;n=window.Backbone;r=window}n.Relational={showWarnings:true};n.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=e}};n.BlockingQueue=function(){this._queue=[]};t.extend(n.BlockingQueue.prototype,n.Semaphore,{_queue:null,add:function(e){if(this.isBlocked()){this._queue.push(e)}else{e()}},process:function(){while(this._queue&&this._queue.length){this._queue.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});n.Relational.eventQueue=new n.BlockingQueue;n.Store=function(){this._collections=[];this._reverseRelations=[];this._orphanRelations=[];this._subModels=[];this._modelScopes=[r]};t.extend(n.Store.prototype,n.Events,{initializeRelation:function(e,r,i){var s=!t.isString(r.type)?r.type:n[r.type]||this.getObjectByName(r.type);if(s&&s.prototype instanceof n.Relation){new s(e,r,i)}else{n.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",r)}},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=t.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(e){t.find(this._subModels,function(n){return t.find(n.subModels||[],function(t,r){var i=this.getObjectByName(t);if(e===i){n.superModelType._subModels[r]=e;e._superModel=n.superModelType;e._subModelTypeValue=r;e._subModelTypeAttribute=n.superModelType.prototype.subModelTypeAttribute;return true}},this)},this)},addReverseRelation:function(e){var n=t.any(this._reverseRelations,function(n){return t.all(e||[],function(e,t){return e===n[t]})});if(!n&&e.model&&e.type){this._reverseRelations.push(e);this._addRelation(e.model,e);this.retroFitRelation(e)}},addOrphanRelation:function(e){var n=t.any(this._orphanRelations,function(n){return t.all(e||[],function(e,t){return e===n[t]})});if(!n&&e.model&&e.type){this._orphanRelations.push(e)}},processOrphanRelations:function(){t.each(this._orphanRelations.slice(0),function(e){var r=n.Relational.store.getObjectByName(e.relatedModel);if(r){this.initializeRelation(null,e);this._orphanRelations=t.without(this._orphanRelations,e)}},this)},_addRelation:function(e,n){if(!e.prototype.relations){e.prototype.relations=[]}e.prototype.relations.push(n);t.each(e._subModels||[],function(e){this._addRelation(e,n)},this)},retroFitRelation:function(e){var t=this.getCollection(e.model,false);t&&t.each(function(t){if(!(t instanceof e.model)){return}new e.type(t,e)},this)},getCollection:function(e,r){if(e instanceof n.RelationalModel){e=e.constructor}var i=e;while(i._superModel){i=i._superModel}var s=t.findWhere(this._collections,{model:i});if(!s&&r!==false){s=this._createCollection(i)}return s},getObjectByName:function(n){var r=n.split("."),i=null;t.find(this._modelScopes,function(n){i=t.reduce(r||[],function(t,n){return t?t[n]:e},n);if(i&&i!==n){return true}},this);return i},_createCollection:function(e){var t;if(e instanceof n.RelationalModel){e=e.constructor}if(e.prototype instanceof n.RelationalModel){t=new n.Collection;t.model=e;this._collections.push(t)}return t},resolveIdForItem:function(e,r){var i=t.isString(r)||t.isNumber(r)?r:null;if(i===null){if(r instanceof n.RelationalModel){i=r.id}else if(t.isObject(r)){i=r[e.prototype.idAttribute]}}if(!i&&i!==0){i=null}return i},find:function(e,t){var n=this.resolveIdForItem(e,t);var r=this.getCollection(e);if(r){var i=r.get(n);if(i instanceof e){return i}}return null},register:function(e){var t=this.getCollection(e);if(t){var n=e.collection;t.add(e);this.listenTo(e,"destroy",this.unregister,this);e.collection=n}},checkId:function(e,t){var r=this.getCollection(e),i=r&&r.get(t);if(i&&e!==i){if(n.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",i,e)}throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}},update:function(e){var t=this.getCollection(e);t._onModelEvent("change:"+e.idAttribute,e,t);e.trigger("relational:change:id",e,t)},unregister:function(e){this.stopListening(e,"destroy",this.unregister);var t=this.getCollection(e);t&&t.remove(e)},reset:function(){this.stopListening();this._collections=[];this._subModels=[];this._modelScopes=[r]}});n.Relational.store=new n.Store;n.Relation=function(e,r,i){this.instance=e;r=t.isObject(r)?r:{};this.reverseRelation=t.defaults(r.reverseRelation||{},this.options.reverseRelation);this.options=t.defaults(r,this.options,n.Relation.prototype.options);this.reverseRelation.type=!t.isString(this.reverseRelation.type)?this.reverseRelation.type:n[this.reverseRelation.type]||n.Relational.store.getObjectByName(this.reverseRelation.type);this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.model=this.options.model||this.instance.constructor;this.relatedModel=this.options.relatedModel;if(t.isString(this.relatedModel)){this.relatedModel=n.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){n.Relational.store.addReverseRelation(t.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}if(e){var s=this.keySource;if(s!==this.key&&typeof this.instance.get(this.key)==="object"){s=this.key}this.setKeyContents(this.instance.get(s));this.relatedCollection=n.Relational.store.getCollection(this.relatedModel);if(this.keySource!==this.key){this.instance.unset(this.keySource,{silent:true})}this.instance._relations[this.key]=this;this.initialize(i);if(this.options.autoFetch){this.instance.fetchRelated(this.key,t.isObject(this.options.autoFetch)?this.options.autoFetch:{})}this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}};n.Relation.extend=n.Model.extend;t.extend(n.Relation.prototype,n.Events,n.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false,autoFetch:false,parse:false},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,r=this.key,i=this.model,s=this.relatedModel,o=n.Relational.showWarnings&&typeof console!=="undefined";if(!i||!r||!s){o&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,i,r,s);return false}if(!(i.prototype instanceof n.RelationalModel)){o&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e);return false}if(!(s.prototype instanceof n.RelationalModel)){o&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,s);return false}if(this instanceof n.HasMany&&this.reverseRelation.type===n.HasMany){o&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(e&&t.keys(e._relations).length){var u=t.find(e._relations,function(e){return e.key===r},this);if(u){o&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,r,e,u);return false}}return true},setRelated:function(e){this.related=e;this.instance.acquire();this.instance.attributes[this.key]=e;this.instance.release()},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){var n=[];var r=!t.isUndefined(e)?[e]:this.related&&(this.related.models||[this.related]);t.each(r||[],function(e){t.each(e.getRelations()||[],function(e){if(this._isReverseRelation(e)){n.push(e)}},this)},this);return n},destroy:function(){this.stopListening();if(this instanceof n.HasOne){this.setRelated(null)}else if(this instanceof n.HasMany){this.setRelated(this._prepareCollection())}t.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}});n.HasOne=n.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var n=this.findRelated(e);this.setRelated(n);t.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,e)},this)},findRelated:function(e){var n=null;e=t.defaults({parse:this.options.parse},e);if(this.keyContents instanceof this.relatedModel){n=this.keyContents}else if(this.keyContents||this.keyContents===0){var r=t.defaults({create:this.options.createModels},e);n=this.relatedModel.findOrCreate(this.keyContents,r)}if(this.related){this.keyId=null}return n},setKeyContents:function(e){this.keyContents=e;this.keyId=n.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,r,i){if(this.isLocked()){return}this.acquire();i=i?t.clone(i):{};var s=t.isUndefined(i.__related),o=s?this.related:i.__related;if(s){this.setKeyContents(r);var u=this.findRelated(i);this.setRelated(u)}if(o&&this.related!==o){t.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,i)},this)}t.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this);if(!i.silent&&this.related!==o){var a=this;this.changed=true;n.Relational.eventQueue.add(function(){a.instance.trigger("change:"+a.key,a.instance,a.related,i,true);a.changed=false})}this.release()},tryAddRelated:function(e,t,n){if((this.keyId||this.keyId===0)&&e.id===this.keyId){this.addRelated(e,n);this.keyId=null}},addRelated:function(e,n){var r=this;e.queue(function(){if(e!==r.related){var i=r.related||null;r.setRelated(e);r.onChange(r.instance,e,t.defaults({__related:i},n))}})},removeRelated:function(e,n,r){if(!this.related){return}if(e===this.related){var i=this.related||null;this.setRelated(null);this.onChange(this.instance,e,t.defaults({__related:i},r))}}});n.HasMany=n.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:n.Collection,collectionKey:true,collectionOptions:{}},initialize:function(e){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(t.isString(this.collectionType)){this.collectionType=n.Relational.store.getObjectByName(this.collectionType)}if(this.collectionType!==n.Collection&&!(this.collectionType.prototype instanceof n.Collection)){throw new Error("`collectionType` must inherit from Backbone.Collection")}var r=this.findRelated(e);this.setRelated(r)},_prepareCollection:function(e){if(this.related){this.stopListening(this.related)}if(!e||!(e instanceof n.Collection)){var r=t.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;e=new this.collectionType(null,r)}e.model=this.relatedModel;if(this.options.collectionKey){var i=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(e[i]&&e[i]!==this.instance){if(n.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,i,this.options.collectionKey)}}else if(i){e[i]=this.instance}}this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset);return e},findRelated:function(e){var r=null;e=t.defaults({parse:this.options.parse},e);if(this.keyContents instanceof n.Collection){this._prepareCollection(this.keyContents);r=this.keyContents}else{var i=[];t.each(this.keyContents,function(n){if(n instanceof this.relatedModel){var r=n}else{r=this.relatedModel.findOrCreate(n,t.extend({merge:true},e,{create:this.options.createModels}))}r&&i.push(r)},this);if(this.related instanceof n.Collection){r=this.related}else{r=this._prepareCollection()}r.set(i,t.defaults({merge:false,parse:false},e))}this.keyIds=t.difference(this.keyIds,t.pluck(r.models,"id"));return r},setKeyContents:function(e){this.keyContents=e instanceof n.Collection?e:null;this.keyIds=[];if(!this.keyContents&&(e||e===0)){this.keyContents=t.isArray(e)?e:[e];t.each(this.keyContents,function(e){var t=n.Relational.store.resolveIdForItem(this.relatedModel,e);if(t||t===0){this.keyIds.push(t)}},this)}},onChange:function(e,r,i){i=i?t.clone(i):{};this.setKeyContents(r);this.changed=false;var s=this.findRelated(i);this.setRelated(s);if(!i.silent){var o=this;n.Relational.eventQueue.add(function(){if(o.changed){o.instance.trigger("change:"+o.key,o.instance,o.related,i,true);o.changed=false}})}},handleAddition:function(e,r,i){i=i?t.clone(i):{};this.changed=true;t.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var s=this;!i.silent&&n.Relational.eventQueue.add(function(){s.instance.trigger("add:"+s.key,e,s.related,i)})},handleRemoval:function(e,r,i){i=i?t.clone(i):{};this.changed=true;t.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,i)},this);var s=this;!i.silent&&n.Relational.eventQueue.add(function(){s.instance.trigger("remove:"+s.key,e,s.related,i)})},handleReset:function(e,r){var i=this;r=r?t.clone(r):{};!r.silent&&n.Relational.eventQueue.add(function(){i.instance.trigger("reset:"+i.key,i.related,r)})},tryAddRelated:function(e,n,r){var i=t.contains(this.keyIds,e.id);if(i){this.addRelated(e,r);this.keyIds=t.without(this.keyIds,e.id)}},addRelated:function(e,n){var r=this;e.queue(function(){if(r.related&&!r.related.get(e)){r.related.add(e,t.defaults({parse:false},n))}})},removeRelated:function(e,t,n){if(this.related.get(e)){this.related.remove(e,n)}}});n.RelationalModel=n.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,r){if(r&&r.collection){var i=this,s=this.collection=r.collection;delete r.collection;this._deferProcessing=true;var o=function(e){if(e===i){i._deferProcessing=false;i.processQueue();s.off("relational:add",o)}};s.on("relational:add",o);t.defer(function(){o(i)})}n.Relational.store.processOrphanRelations();this._queue=new n.BlockingQueue;this._queue.block();n.Relational.eventQueue.block();try{n.Model.apply(this,arguments)}finally{n.Relational.eventQueue.unblock()}},trigger:function(e){if(e.length>5&&e.indexOf("change")===0){var t=this,r=arguments;n.Relational.eventQueue.add(function(){if(!t._isInitialized){return}var i=true;if(e==="change"){i=t.hasChanged()}else{var s=e.slice(7),o=t.getRelation(s);if(o){i=r[4]===true;if(i){t.changed[s]=r[2]}else if(!o.changed){delete t.changed[s]}}}i&&n.Model.prototype.trigger.apply(t,r)})}else{n.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(e){this.acquire();this._relations={};t.each(this.relations||[],function(t){n.Relational.store.initializeRelation(this,t,e)},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(e){if(this._isInitialized&&!this.isLocked()){t.each(this._relations,function(t){var n=this.attributes[t.keySource]||this.attributes[t.key];if(t.related!==n){this.trigger("relational:change:"+t.key,this,n,e||{})}},this)}},queue:function(e){this._queue.add(e)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(e){return this._relations[e]},getRelations:function(){return t.values(this._relations)},fetchRelated:function(e,r,i){r=t.extend({update:true,remove:false},r);var s,o=[],u=this.getRelation(e),a=u&&(u.keyIds||(u.keyId||u.keyId===0?[u.keyId]:[]));if(i){var f=u.related instanceof n.Collection?u.related.models:[u.related];t.each(f,function(e){if(e.id||e.id===0){a.push(e.id)}})}if(a&&a.length){var l=[],f=t.map(a,function(e){var t=n.Relational.store.find(u.relatedModel,e);if(!t){var i={};i[u.relatedModel.prototype.idAttribute]=e;t=u.relatedModel.findOrCreate(i,r);l.push(t)}return t},this);if(u.related instanceof n.Collection&&t.isFunction(u.related.url)){s=u.related.url(f)}if(s&&s!==u.related.url()){var c=t.defaults({error:function(){var e=arguments;t.each(l,function(t){t.trigger("destroy",t,t.collection,r);r.error&&r.error.apply(t,e)})},url:s},r);o=[u.related.fetch(c)]}else{o=t.map(f,function(e){var n=t.defaults({error:function(){if(t.contains(l,e)){e.trigger("destroy",e,e.collection,r);r.error&&r.error.apply(e,arguments)}}},r);return e.fetch(n)},this)}}return o},get:function(r){var i=n.Model.prototype.get.call(this,r);if(!this.dotNotation||r.indexOf(".")===-1){return i}var s=r.split(".");var o=t.reduce(s,function(e,t){if(!(e instanceof n.Model)){throw new Error("Attribute must be an instanceof Backbone.Model. Is: "+e+", currentSplit: "+t)}return n.Model.prototype.get.call(e,t)},this);if(i!==e&&o!==e){throw new Error("Ambiguous result for '"+r+"'. direct result: "+i+", dotNotation: "+o)}return i||o},set:function(e,r,i){n.Relational.eventQueue.block();var s;if(t.isObject(e)||e==null){s=e;i=r}else{s={};s[e]=r}try{var o=this.id,u=s&&this.idAttribute in s&&s[this.idAttribute];n.Relational.store.checkId(this,u);var a=n.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){this.constructor.initializeModelHierarchy();n.Relational.store.register(this);this.initializeRelations(i)}else if(u&&u!==o){n.Relational.store.update(this)}if(s){this.updateRelations(i)}}finally{n.Relational.eventQueue.unblock()}return a},unset:function(e,t){n.Relational.eventQueue.block();var r=n.Model.prototype.unset.apply(this,arguments);this.updateRelations(t);n.Relational.eventQueue.unblock();return r},clear:function(e){n.Relational.eventQueue.block();var t=n.Model.prototype.clear.apply(this,arguments);this.updateRelations(e);n.Relational.eventQueue.unblock();return t},clone:function(){var e=t.clone(this.attributes);if(!t.isUndefined(e[this.idAttribute])){e[this.idAttribute]=null}t.each(this.getRelations(),function(t){delete e[t.key]});return new this.constructor(e)},toJSON:function(e){if(this.isLocked()){return this.id}this.acquire();var r=n.Model.prototype.toJSON.call(this,e);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in r)){r[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue}t.each(this._relations,function(i){var s=r[i.key],o=i.options.includeInJSON,u=null;if(o===true){if(s&&t.isFunction(s.toJSON)){u=s.toJSON(e)}}else if(t.isString(o)){if(s instanceof n.Collection){u=s.pluck(o)}else if(s instanceof n.Model){u=s.get(o)}if(o===i.relatedModel.prototype.idAttribute){if(i instanceof n.HasMany){u=u.concat(i.keyIds)}else if(i instanceof n.HasOne){u=u||i.keyId}}}else if(t.isArray(o)){if(s instanceof n.Collection){u=[];s.each(function(e){var n={};t.each(o,function(t){n[t]=e.get(t)});u.push(n)})}else if(s instanceof n.Model){u={};t.each(o,function(e){u[e]=s.get(e)})}}else{delete r[i.key]}if(o){r[i.keyDestination]=u}if(i.keyDestination!==i.key){delete r[i.key]}});this.release();return r}},{setup:function(e){this.prototype.relations=(this.prototype.relations||[]).slice(0);this._subModels={};this._superModel=null;if(this.prototype.hasOwnProperty("subModelTypes")){n.Relational.store.addSubModels(this.prototype.subModelTypes,this)}else{this.prototype.subModelTypes=null}t.each(this.prototype.relations||[],function(e){if(!e.model){e.model=this}if(e.reverseRelation&&e.model===this){var r=true;if(t.isString(e.relatedModel)){var i=n.Relational.store.getObjectByName(e.relatedModel);r=i&&i.prototype instanceof n.RelationalModel}if(r){n.Relational.store.initializeRelation(null,e)}else if(t.isString(e.relatedModel)){n.Relational.store.addOrphanRelation(e)}}},this);return this},build:function(e,t){var n=this;this.initializeModelHierarchy();if(this._subModels&&this.prototype.subModelTypeAttribute in e){var r=e[this.prototype.subModelTypeAttribute];var i=this._subModels[r];if(i){n=i}}return new n(e,t)},initializeModelHierarchy:function(){if(t.isUndefined(this._superModel)||t.isNull(this._superModel)){n.Relational.store.setupSuperModel(this);if(this._superModel&&this._superModel.prototype.relations){var e=t.select(this._superModel.prototype.relations||[],function(e){return!t.any(this.prototype.relations||[],function(t){return e.relatedModel===t.relatedModel&&e.key===t.key},this)},this);this.prototype.relations=e.concat(this.prototype.relations)}else{this._superModel=false}}if(this.prototype.subModelTypes&&t.keys(this.prototype.subModelTypes).length!==t.keys(this._subModels).length){t.each(this.prototype.subModelTypes||[],function(e){var t=n.Relational.store.getObjectByName(e);t&&t.initializeModelHierarchy()})}},findOrCreate:function(e,r){r||(r={});var i=t.isObject(e)&&r.parse&&this.prototype.parse?this.prototype.parse(e):e;var s=n.Relational.store.find(this,i);if(t.isObject(e)){if(s&&r.merge!==false){delete r.collection;s.set(i,r)}else if(!s&&r.create!==false){s=this.build(e,r)}}return s}});t.extend(n.RelationalModel.prototype,n.Semaphore);n.Collection.prototype.__prepareModel=n.Collection.prototype._prepareModel;n.Collection.prototype._prepareModel=function(e,t){var r;if(e instanceof n.Model){if(!e.collection){e.collection=this}r=e}else{t||(t={});t.collection=this;if(typeof this.model.findOrCreate!=="undefined"){r=this.model.findOrCreate(e,t)}else{r=new this.model(e,t)}if(r&&r.isNew()&&!r._validate(e,t)){this.trigger("invalid",this,e,t);r=false}}return r};var i=n.Collection.prototype.__set=n.Collection.prototype.set;n.Collection.prototype.set=function(e,r){if(!(this.model.prototype instanceof n.RelationalModel)){return i.apply(this,arguments)}if(r&&r.parse){e=this.parse(e,r)}if(!t.isArray(e)){e=e?[e]:[]}var s=[],o=[];t.each(e,function(e){if(!(e instanceof n.Model)){e=n.Collection.prototype._prepareModel.call(this,e,r)}if(e){o.push(e);if(!(this.get(e)||this.get(e.cid))){s.push(e)}else if(e.id!=null){this._byId[e.id]=e}}},this);i.call(this,o,t.defaults({parse:false},r));t.each(s,function(e){if(this.get(e)||this.get(e.cid)){this.trigger("relational:add",e,this,r)}},this);return this};var s=n.Collection.prototype.__remove=n.Collection.prototype.remove;n.Collection.prototype.remove=function(e,r){if(!(this.model.prototype instanceof n.RelationalModel)){return s.apply(this,arguments)}e=t.isArray(e)?e.slice():[e];r||(r={});var i=[];t.each(e,function(e){e=this.get(e)||this.get(e.cid);e&&i.push(e)},this);if(i.length){s.call(this,i,r);t.each(i,function(e){this.trigger("relational:remove",e,this,r)},this)}return this};var o=n.Collection.prototype.__reset=n.Collection.prototype.reset;n.Collection.prototype.reset=function(e,r){r=t.extend({merge:true},r);o.call(this,e,r);if(this.model.prototype instanceof n.RelationalModel){this.trigger("relational:reset",this,r)}return this};var u=n.Collection.prototype.__sort=n.Collection.prototype.sort;n.Collection.prototype.sort=function(e){u.call(this,e);if(this.model.prototype instanceof n.RelationalModel){this.trigger("relational:reset",this,e)}return this};var a=n.Collection.prototype.__trigger=n.Collection.prototype.trigger;n.Collection.prototype.trigger=function(e){if(!(this.model.prototype instanceof n.RelationalModel)){return a.apply(this,arguments)}if(e==="add"||e==="remove"||e==="reset"){var r=this,i=arguments;if(t.isObject(i[3])){i=t.toArray(i);i[3]=t.clone(i[3])}n.Relational.eventQueue.add(function(){a.apply(r,i)})}else{a.apply(this,arguments)}return this};n.RelationalModel.extend=function(e,t){var r=n.Model.extend.apply(this,arguments);r.setup(this);return r}})()