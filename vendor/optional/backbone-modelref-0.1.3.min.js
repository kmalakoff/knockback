// Generated by CoffeeScript 1.3.3
/*
  backbone-modelref.js 0.1.3
  (c) 2011, 2012 Kevin Malakoff.
  Backbone-ModelRef.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/backbone-modelref/blob/master/LICENSE
  Dependencies: Backbone.js and Underscore.js.
*/(function(){var e,t,n={}.hasOwnProperty,r=function(e,t){function i(){this.constructor=e}for(var r in t)n.call(t,r)&&(e[r]=t[r]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};if(typeof require!="undefined")try{t=require("lodash")}catch(i){t=require("underscore")}else t=this._;t&&t.hasOwnProperty("_")&&(t=t._),e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,e.ModelRef=function(){function n(n,r,i){var s,o,u,a,f,l,c;this.collection=n,this.id=r,this.cached_model=i!=null?i:null,t.bindAll(this,"_checkForLoad","_checkForUnload");if(!this.collection)throw new Error("Backbone.ModelRef: collection is missing");this.ref_count=1,this.collection.retain&&this.collection.retain(),this.cached_model&&(this.id=this.cached_model.id),!this.cached_model&&this.id&&(this.cached_model=this.collection.get(this.id));if(this.cached_model){l=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(o=0,a=l.length;o<a;o++)s=l[o],this.collection.bind(s,this._checkForUnload)}else{c=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(u=0,f=c.length;u<f;u++)s=c[u],this.collection.bind(s,this._checkForLoad)}}return n.prototype.retain=function(){return this.ref_count++,this},n.prototype.release=function(){var t,n,r,i,s,o,u;if(this.ref_count<=0)throw new Error("Backbone.ModelRef.release(): ref count is corrupt");this.ref_count--;if(this.ref_count>0)return;if(this.cached_model){o=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(n=0,i=o.length;n<i;n++)t=o[n],this.collection.unbind(t,this._checkForUnload)}else{u=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(r=0,s=u.length;r<s;r++)t=u[r],this.collection.unbind(t,this._checkForLoad)}return this.collection.release&&this.collection.release(),this.collection=null,this},n.prototype.getModel=function(){return this.cached_model&&!this.cached_model.isNew()&&(this.id=this.cached_model.id),this.cached_model?this.cached_model:(this.id&&(this.cached_model=this.collection.get(this.id)),this.cached_model)},n.prototype._checkForLoad=function(){var t,n,r,i,s,o,u,a;if(this.cached_model||!this.id)return;n=this.collection.get(this.id);if(!n)return;u=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(r=0,s=u.length;r<s;r++)t=u[r],this.collection.unbind(t,this._checkForLoad);a=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(i=0,o=a.length;i<o;i++)t=a[i],this.collection.bind(t,this._checkForUnload);return this.cached_model=n,this.trigger("loaded",this.cached_model)},n.prototype._checkForUnload=function(){var t,n,r,i,s,o,u,a;if(!this.cached_model||!this.id)return;n=this.collection.get(this.id);if(n)return;u=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(r=0,s=u.length;r<s;r++)t=u[r],this.collection.unbind(t,this._checkForUnload);a=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(i=0,o=a.length;i<o;i++)t=a[i],this.collection.bind(t,this._checkForLoad);return n=this.cached_model,this.cached_model=null,this.trigger("unloaded",n)},n}(),r(e.ModelRef.prototype,e.Events),e.ModelRef.VERSION="0.1.3",e.ModelRef.MODEL_EVENTS_WHEN_LOADED=["reset","remove"],e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED=["reset","add"],e.Model.prototype.model=function(){if(arguments.length===0)return this;throw new Error("cannot set a Backbone.Model")},e.Model.prototype.isLoaded=function(){return!0},e.Model.prototype.bindLoadingStates=function(e){return t.isFunction(e)?e(this):e.loaded&&e.loaded(this),this},e.Model.prototype.unbindLoadingStates=function(e){return this},e.ModelRef.prototype.get=function(e){if(e!=="id")throw new Error("Backbone.ModelRef.get(): only id is permitted");return this.cached_model&&!this.cached_model.isNew()&&(this.id=this.cached_model.id),this.id},e.ModelRef.prototype.model=function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m;if(arguments.length===0)return this.getModel();if(t&&t.collection!==this.collection)throw new Error("Backbone.ModelRef.model(): collections don't match");n=this.id?!t||this.id!==t.get("id"):!!t;if(!n)return;if(this.cached_model){i=this.cached_model,this.id=null,this.cached_model=null,p=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(s=0,f=p.length;s<f;s++)r=p[s],this.collection.unbind(r,this._checkForUnload);d=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(o=0,l=d.length;o<l;o++)r=d[o],this.collection.bind(r,this._checkForLoad);this.trigger("unloaded",i)}if(!t)return;this.id=t.get("id"),this.cached_model=t.model(),v=e.ModelRef.MODEL_EVENTS_WHEN_UNLOADED;for(u=0,c=v.length;u<c;u++)r=v[u],this.collection.unbind(r,this._checkForLoad);m=e.ModelRef.MODEL_EVENTS_WHEN_LOADED;for(a=0,h=m.length;a<h;a++)r=m[a],this.collection.bind(r,this._checkForUnload);return this.trigger("loaded",this.cached_model)},e.ModelRef.prototype.isLoaded=function(){var e;return e=this.getModel(),e?e.isLoaded?e.isLoaded():!0:!1},e.ModelRef.prototype.bindLoadingStates=function(e){var n;return t.isFunction(e)?this.bind("loaded",e):(e.loaded&&this.bind("loaded",e.loaded),e.unloaded&&this.bind("unloaded",e.unloaded)),n=this.model(),n?n.bindLoadingStates(e):null},e.ModelRef.prototype.unbindLoadingStates=function(e){return t.isFunction(e)?this.unbind("loaded",e):(e.loaded&&this.unbind("loaded",e.loaded),e.unloaded&&this.unbind("unloaded",e.unloaded)),this.model()},typeof exports!="undefined"&&(module.exports=e.ModelRef),this.Backbone&&(this.Backbone.ModelRef=e.ModelRef),e.ModelRef.VERSION="0.1.3"}).call(this);